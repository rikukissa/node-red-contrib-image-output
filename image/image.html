module.exports = function(RED) {
    const imageThumbnail = require('image-thumbnail');
    
    function ImageNode(config) {
        RED.nodes.createNode(this, config);
        this.imageWidth = config.width;
        this.thumbnail = config.thumbnail;
        
        var node = this;
        
        function sendImageToClient(image, msg) {
            try {
                RED.comms.publish("image", { id:node.id, data:image });
                if (msg.hasOwnProperty("filename")) { node.status({text:" " + msg.filename}); }
            }
            catch(e) {
                node.error("Invalid image", msg);
            }
        }

        node.on("input", function(msg) {
            var image = msg.payload;
            
            if (!Buffer.isBuffer(image) && (typeof image !== 'string') && !(image instanceof String)) {
                node.error("Input should be a buffer or a base64 string (containing a jpg or png image)");
                return;
            }
            
            if (node.thumbnail) {
                // The thumbnail node allows both Buffers and base64 strings as image input
                let options = { width: node.imageWidth, responseType: 'base64' };

                image = imageThumbnail(image, options).then(function (thumbnailImage) { 
                    sendImageToClient(thumbnailImage, msg);
                }).catch(function (err) {
                    // Log the error and keep the original image (at its original size)
                    console.error(err);
                })
            }
            
            if (Buffer.isBuffer(image)) {
                image = image.toString("base64");
            }
            
            sendImageToClient(image, msg);
        });

        node.on("close", function() {
            RED.comms.publish("image", { id:this.id });
            node.status({});
        });
    }
    RED.nodes.registerType("image", ImageNode);
};
